# Usa imagem base com Node (Debian, já com apt)
FROM node:20-bullseye

# Instala Python 3 + pip + venv
RUN apt-get update && apt-get install -y python3 python3-pip python3-venv \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copia e instala dependências Node
COPY package*.json ./
RUN npm ci --omit=dev || npm install --production

# Copia requirements do Python e instala
COPY requirements.txt ./
RUN python3 -m venv .venv \
    && . .venv/bin/activate \
    && pip install --no-cache-dir -r requirements.txt

# Copia o restante do projeto
COPY . .

# Executa o prepara.py e inicia o servidor Node
CMD [ "bash", "-lc", ". .venv/bin/activate && python prepara.py && node server.js" ]